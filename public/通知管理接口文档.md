# 通知管理接口文档

## 概述

本文档描述了通知管理模块的所有API接口，包括通知的创建、查询、更新、删除和邮件发送功能。所有接口都需要管理员权限。

## 基础信息

- **基础路径**: `/admin/notification/`
- **认证方式**: 需要管理员权限（AdminPermissionMixin）
- **响应格式**: JSON
- **字符编码**: UTF-8

## 通用响应格式

### 成功响应
```json
{
    "code": 200,
    "msg": "操作成功",
    "data": {}
}
```

### 失败响应
```json
{
    "code": 400,
    "msg": "错误信息",
    "data": null
}
```

## 接口列表

### 1. 获取通知列表

**接口描述**: 获取所有通知列表，支持分页和搜索

- **URL**: `GET /admin/notification/list/`
- **请求方式**: GET
- **权限要求**: 管理员权限

#### 请求参数

| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| query | string | 否 | "" | 搜索关键词，支持标题和内容搜索 |
| page | int | 否 | 1 | 页码 |
| page_size | int | 否 | 10 | 每页数量 |
| is_active | string | 否 | "" | 是否激活（"true"/"false"/""） |

#### 响应示例

```json
{
    "code": 200,
    "msg": "操作成功",
    "data": {
        "total": 50,
        "page": 1,
        "page_size": 10,
        "notifications": [
            {
                "id": 1,
                "title": "系统维护通知",
                "content": "系统将于今晚进行维护",
                "created_at": "2024-01-01 10:00:00",
                "creator": {
                    "id": 1,
                    "username": "admin"
                },
                "is_public": true,
                "notify_all": true,
                "email_notification": true,
                "email_sent": true,
                "is_active": true
            }
        ]
    }
}
```

### 2. 获取通知详情

**接口描述**: 获取指定通知的详细信息

- **URL**: `GET /admin/notification/detail/{notification_id}/`
- **请求方式**: GET
- **权限要求**: 管理员权限

#### 路径参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| notification_id | int | 是 | 通知ID |

#### 响应示例

```json
{
    "code": 200,
    "msg": "操作成功",
    "data": {
        "id": 1,
        "title": "系统维护通知",
        "content": "系统将于今晚进行维护",
        "created_at": "2024-01-01 10:00:00",
        "updated_at": "2024-01-01 10:30:00",
        "creator": {
            "id": 1,
            "username": "admin"
        },
        "is_public": true,
        "notify_all": true,
        "email_notification": true,
        "email_sent": true,
        "is_active": true,
        "read_count": 25
    }
}
```

#### 错误响应

```json
{
    "code": 400,
    "msg": "通知不存在",
    "data": null
}
```

### 3. 创建通知

**接口描述**: 创建新的通知

- **URL**: `POST /admin/notification/create/`
- **请求方式**: POST
- **权限要求**: 管理员权限
- **Content-Type**: application/json

#### 请求参数

| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| title | string | 是 | - | 通知标题 |
| content | string | 是 | - | 通知内容 |
| is_public | boolean | 否 | true | 是否公开 |
| notify_all | boolean | 否 | false | 是否通知所有用户 |
| email_notification | boolean | 否 | false | 是否发送邮件通知 |
| recipient_user_ids | array | 否 | [] | 指定接收用户ID列表（当notify_all为false时使用） |

#### 请求示例

```json
{
    "title": "系统维护通知",
    "content": "系统将于今晚22:00-24:00进行维护，期间服务可能中断",
    "is_public": true,
    "notify_all": true,
    "email_notification": true,
    "recipient_user_ids": []
}
```

#### 响应示例

```json
{
    "code": 200,
    "msg": "通知创建成功",
    "data": {
        "notification_id": 1
    }
}
```

#### 错误响应

```json
{
    "code": 400,
    "msg": "标题和内容不能为空",
    "data": null
}
```

### 4. 更新通知

**接口描述**: 更新指定通知的信息

- **URL**: `PUT /admin/notification/update/{notification_id}/`
- **请求方式**: PUT
- **权限要求**: 管理员权限
- **Content-Type**: application/json

#### 路径参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| notification_id | int | 是 | 通知ID |

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| title | string | 是 | 通知标题 |
| content | string | 是 | 通知内容 |
| is_public | boolean | 否 | 是否公开 |
| is_active | boolean | 否 | 是否激活 |

#### 请求示例

```json
{
    "title": "系统维护通知（更新）",
    "content": "系统维护时间调整为今晚23:00-01:00",
    "is_public": true,
    "is_active": true
}
```

#### 响应示例

```json
{
    "code": 200,
    "msg": "通知更新成功",
    "data": null
}
```

#### 错误响应

```json
{
    "code": 400,
    "msg": "通知不存在",
    "data": null
}
```

### 5. 删除通知

**接口描述**: 批量删除通知

- **URL**: `POST /admin/notification/delete/`
- **请求方式**: POST
- **权限要求**: 管理员权限
- **Content-Type**: application/json

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| notification_ids | array | 是 | 要删除的通知ID列表 |

#### 请求示例

```json
{
    "notification_ids": [1, 2, 3]
}
```

#### 响应示例

```json
{
    "code": 200,
    "msg": "成功删除3条通知",
    "data": null
}
```

#### 错误响应

```json
{
    "code": 400,
    "msg": "请选择要删除的通知",
    "data": null
}
```

### 6. 发送邮件通知

**接口描述**: 为指定通知发送邮件通知

- **URL**: `POST /admin/notification/send-email/`
- **请求方式**: POST
- **权限要求**: 管理员权限
- **Content-Type**: application/json

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| notification_id | int | 是 | 通知ID |

#### 请求示例

```json
{
    "notification_id": 1
}
```

#### 响应示例

```json
{
    "code": 200,
    "msg": "邮件通知发送成功",
    "data": null
}
```

#### 错误响应

```json
{
    "code": 400,
    "msg": "该通知已发送过邮件",
    "data": null
}
```

或

```json
{
    "code": 400,
    "msg": "邮件通知发送失败，请检查邮件配置或收件人列表",
    "data": null
}
```

## 数据模型

### Notification 通知模型

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | int | 通知ID |
| title | string | 通知标题 |
| content | text | 通知内容 |
| creator | object | 创建者信息 |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |
| is_public | boolean | 是否公开 |
| notify_all | boolean | 是否通知所有用户 |
| email_notification | boolean | 是否启用邮件通知 |
| email_sent | boolean | 邮件是否已发送 |
| is_active | boolean | 是否激活 |
| read_count | int | 已读用户数量（仅在详情接口返回） |

### Creator 创建者模型

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | int | 用户ID |
| username | string | 用户名 |

## 邮件发送功能说明

### 邮件配置要求

邮件发送功能需要以下配置项：

- `EMAIL_HOST`: SMTP服务器地址
- `EMAIL_PORT`: SMTP服务器端口
- `EMAIL_HOST_USER`: SMTP用户名
- `EMAIL_HOST_PASSWORD`: SMTP密码
- `DEFAULT_FROM_EMAIL`: 默认发件人邮箱

### 收件人规则

1. 如果 `notify_all` 为 `true`，则发送给所有激活用户
2. 如果 `notify_all` 为 `false`，则发送给指定的用户列表
3. 只有邮箱地址不为空的用户才会收到邮件

### 邮件发送状态

- 邮件发送成功后，`email_sent` 字段会被设置为 `true`
- 已发送过邮件的通知不能重复发送
- 邮件发送过程中的错误会被记录到控制台日志

## 错误码说明

| 错误码 | 说明 |
|--------|------|
| 200 | 操作成功 |
| 400 | 请求参数错误或业务逻辑错误 |
| 401 | 未授权访问 |
| 403 | 权限不足 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

## 注意事项

1. 所有接口都需要管理员权限，请确保请求头中包含有效的认证信息
2. 创建通知时，如果启用邮件通知但邮件配置不正确，通知仍会创建成功，但邮件发送会失败
3. 删除通知时会同时删除相关的用户通知关联记录
4. 分页查询时，建议合理设置 `page_size` 参数以避免性能问题
5. 搜索功能支持标题和内容的模糊匹配，不区分大小写

## 更新日志

- v1.0.0: 初始版本，包含基础的CRUD操作和邮件发送功能